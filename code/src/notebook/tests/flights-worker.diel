CREATE EVENT TABLE originSelectionEvent (origin text);

create view currentOriginSelection AS
  select origin, timestep from originSelectionEvent
    where timestep = (select max(timestep) from originSelectionEvent);

create output allPastSelections AS
  select distinct origin from originSelectionEvent order by timestep;

create output delayDistanceByOrigin AS
  select *
  from delayDistanceByOriginEvent e;

-- FIXME: something wrong with the lineage of events...
  -- join currentOriginSelection s on e.lineage = s.timestep;

-- sampling 200
create table sampledFlights AS
  select *
  from flights
  order by random() limit 200;

-- sampled scatterplot implementation
create event view delayDistanceByOriginEvent AS
  select
    f.delay,
    f.distance
  from sampledFlights f
  join currentOriginSelection s on f.origin = s.origin;

-- heatmap implementation
-- capped at 2000 for distance
-- and -100 to 500 for delay
-- create event view delayDistanceByOriginEvent AS
--   select
--     max(min(round(f.delay / 10) * 10, 500), -100) as delay_bin,
--     min(round(f.distance / 100) * 100, 2000) as distance_bin,
--     count(*) as count
--   from flights f
--   join currentOriginSelection s on f.origin = s.origin
--   group by delay_bin, distance_bin;

-- note: this is a bit annoying...
create output allOriginAirports AS
  select * from allOriginAirportsEvent;

create event view allOriginAirportsEvent AS
  select
    origin,
    count() as c
  from flights
    group by origin
  order by c
  limit 10;